<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartQuizzer - All Users</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
        :root{
            --primary:#4361ee;--secondary:#3a0ca3;--accent:#f72585;--light:#f8f9fa;--dark:#212529;--success:#4cc9f0;--warning:#f9c74f;--danger:#e63946;
            --gradient:linear-gradient(135deg,#4361ee 0%,#7209b7 100%);
            --card-bg:rgba(255,255,255,.1);
        }
        body{
            background:var(--gradient);
            color:var(--light);
            min-height:100vh;
            padding:20px;
        }
        .container{max-width:1400px;margin:0 auto}
        
        /* Header */
        .header{
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:30px;
            padding:20px 0;
        }
        .header h1{
            font-size:2.5rem;
            background:linear-gradient(to right,#fff,#4cc9f0);
            -webkit-background-clip:text;
            background-clip:text;
            -webkit-text-fill-color:transparent;
        }
        .header-actions{
            display:flex;
            gap:15px;
        }
        .btn{
            padding:10px 20px;
            border:none;
            border-radius:25px;
            cursor:pointer;
            text-decoration:none;
            font-weight:600;
            transition:all .3s;
            display:inline-flex;
            align-items:center;
            gap:8px;
        }
        .btn-primary{background:var(--primary);color:white}
        .btn-secondary{background:rgba(255,255,255,.2);color:white}
        .btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,.2)}
        
        /* Analytics Section */
        .analytics-section{
            background:var(--card-bg);
            backdrop-filter:blur(10px);
            border-radius:20px;
            padding:30px;
            margin-bottom:30px;
            border:1px solid rgba(255,255,255,.1);
        }
        .analytics-header{
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:25px;
        }
        .analytics-title{
            font-size:1.8rem;
            color:rgba(255,255,255,.9);
            display:flex;
            align-items:center;
            gap:10px;
        }
        .period-controls{
            display:flex;
            gap:10px;
        }
        .period-btn{
            padding:8px 16px;
            background:rgba(255,255,255,.2);
            color:white;
            border:none;
            border-radius:20px;
            cursor:pointer;
            font-size:.9rem;
            transition:all .3s;
        }
        .period-btn.active{
            background:var(--success);
            transform:scale(1.05);
        }
        .period-btn:hover{background:rgba(255,255,255,.3)}
        
        /* Stats Grid */
        .stats-grid{
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
            gap:20px;
            margin-bottom:30px;
        }
        .stat-card{
            background:rgba(255,255,255,.1);
            border-radius:15px;
            padding:20px;
            text-align:center;
            transition:transform .3s;
            border:1px solid rgba(255,255,255,.1);
        }
        .stat-card:hover{transform:translateY(-5px)}
        .stat-card i{
            font-size:2rem;
            margin-bottom:10px;
            color:var(--success);
        }
        .stat-number{
            font-size:2rem;
            font-weight:700;
            color:white;
            display:block;
        }
        .stat-label{
            color:rgba(255,255,255,.8);
            font-size:.9rem;
        }
        
        /* Chart Container */
        .chart-container{
            background:rgba(0,0,0,.2);
            border-radius:15px;
            padding:20px;
            margin-bottom:30px;
            position:relative;
        }
        .chart-loading{
            position:absolute;
            top:50%;
            left:50%;
            transform:translate(-50%,-50%);
            display:none;
        }
        .spinner{
            border:3px solid rgba(255,255,255,.3);
            border-top:3px solid var(--success);
            border-radius:50%;
            width:40px;
            height:40px;
            animation:spin 1s linear infinite;
        }
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        
        /* Users Table */
        .users-section{
            background:var(--card-bg);
            backdrop-filter:blur(10px);
            border-radius:20px;
            padding:30px;
            border:1px solid rgba(255,255,255,.1);
        }
        .section-title{
            font-size:1.5rem;
            margin-bottom:20px;
            color:rgba(255,255,255,.9);
            display:flex;
            align-items:center;
            gap:10px;
        }
        .users-table{
            width:100%;
            border-collapse:collapse;
            background:rgba(0,0,0,.2);
            border-radius:10px;
            overflow:hidden;
        }
        .users-table th,.users-table td{
            padding:15px;
            text-align:left;
            border-bottom:1px solid rgba(255,255,255,.1);
        }
        .users-table th{
            background:rgba(0,0,0,.3);
            font-weight:600;
            color:rgba(255,255,255,.9);
        }
        .users-table tr:hover{
            background:rgba(255,255,255,.05);
        }
        .user-avatar{
            width:40px;
            height:40px;
            border-radius:50%;
            background:var(--primary);
            display:flex;
            align-items:center;
            justify-content:center;
            color:white;
            font-weight:600;
            margin-right:10px;
        }
        .user-info{
            display:flex;
            align-items:center;
        }
        .status-badge{
            padding:4px 12px;
            border-radius:15px;
            font-size:.8rem;
            font-weight:600;
        }
        .status-active{background:rgba(76,201,240,.2);color:var(--success)}
        .status-inactive{background:rgba(230,57,70,.2);color:var(--danger)}
        
        /* Real-time indicator */
        .real-time-indicator{
            display:flex;
            align-items:center;
            gap:8px;
            font-size:.9rem;
            color:rgba(255,255,255,.7);
        }
        .pulse-dot{
            width:8px;
            height:8px;
            background:var(--success);
            border-radius:50%;
            animation:pulse 2s infinite;
        }
        @keyframes pulse{
            0%{opacity:1;transform:scale(1)}
            50%{opacity:.5;transform:scale(1.1)}
            100%{opacity:1;transform:scale(1)}
        }
        @keyframes spin{
            0%{transform:rotate(0deg)}
            100%{transform:rotate(360deg)}
        }
        
        /* Responsive */
        @media (max-width:768px){
            .header{flex-direction:column;gap:20px}
            .analytics-header{flex-direction:column;gap:15px}
            .stats-grid{grid-template-columns:1fr}
            .users-table{font-size:.9rem}
        }
    </style>
</head>
<body>
    {% csrf_token %}
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-users"></i> All Users</h1>
            <div class="header-actions">
                <div class="real-time-indicator">
                    <div class="pulse-dot"></div>
                    <span>Live Data</span>
                </div>
                <a href="{% url 'admindashboard' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>
        
        <!-- Real-time Analytics Section -->
        <div class="analytics-section">
            <div class="analytics-header">
                <h2 class="analytics-title">
                    <i class="fas fa-chart-line"></i>
                    User Growth Analytics
                </h2>
                <div class="period-controls">
                    <button class="period-btn active" onclick="updateGrowthChart('week')" data-period="week">
                        <i class="fas fa-calendar-week"></i> Week
                    </button>
                    <button class="period-btn" onclick="updateGrowthChart('month')" data-period="month">
                        <i class="fas fa-calendar-alt"></i> Month
                    </button>
                    <button class="period-btn" onclick="updateGrowthChart('year')" data-period="year">
                        <i class="fas fa-calendar"></i> Year
                    </button>
                </div>
            </div>
            
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <i class="fas fa-users"></i>
                    <span class="stat-number" id="totalUsers">{{ users.count }}</span>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-user-plus"></i>
                    <span class="stat-number" id="newToday">0</span>
                    <div class="stat-label">New Today</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-user-check"></i>
                    <span class="stat-number" id="activeUsers">0</span>
                    <div class="stat-label">Active Users</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-chart-bar"></i>
                    <span class="stat-number" id="quizzesToday">0</span>
                    <div class="stat-label">Quizzes Today</div>
                </div>
            </div>
            
            <!-- Chart -->
            <div class="chart-container">
                <div class="chart-loading" id="chartLoading">
                    <div class="spinner"></div>
                </div>
                <canvas id="userGrowthChart" width="400" height="200"></canvas>
            </div>
        </div>
        
        <!-- Users Table Section -->
        <div class="users-section">
            <h2 class="section-title">
                <i class="fas fa-table"></i>
                User Management
            </h2>
            
            <table class="users-table">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Email</th>
                        <th>Joined</th>
                        <th>Status</th>
                        <th>Quizzes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>
                            <div class="user-info">
                                <div class="user-avatar">
                                    {{ user.username|first|upper }}
                                </div>
                                <div>
                                    <div style="font-weight:600">{{ user.username }}</div>
                                    <div style="font-size:.8rem;opacity:.7">{{ user.first_name }} {{ user.last_name }}</div>
                                </div>
                            </div>
                        </td>
                        <td>{{ user.email }}</td>
                        <td>{{ user.date_joined|date:"M d, Y" }}</td>
                        <td>
                            <span class="status-badge status-{% if user.is_active %}active{% else %}inactive{% endif %}">
                                {% if user.is_active %}Active{% else %}Inactive{% endif %}
                            </span>
                        </td>
                        <td>{{ user.quiz_count|default:0 }}</td>
                        <td>
                            <button class="btn btn-primary" onclick="editUser({{ user.id }}, '{{ user.username }}', '{{ user.email }}', '{{ user.first_name }}', '{{ user.last_name }}')" style="padding:5px 10px;font-size:.8rem;margin-right:5px">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            {% if user.is_active %}
                            <button class="btn" onclick="blockUser({{ user.id }}, '{{ user.username }}')" style="padding:5px 10px;font-size:.8rem;background:#e63946;color:white">
                                <i class="fas fa-ban"></i> Block
                            </button>
                            {% else %}
                            <button class="btn" onclick="unblockUser({{ user.id }}, '{{ user.username }}')" style="padding:5px 10px;font-size:.8rem;background:#4cc9f0;color:white">
                                <i class="fas fa-check"></i> Unblock
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" style="text-align:center;padding:40px;opacity:.7">
                            <i class="fas fa-users" style="font-size:2rem;margin-bottom:10px;display:block"></i>
                            No users found
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Edit User Modal -->
    <div id="editModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;">
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#4361ee 0%,#7209b7 100%);padding:30px;border-radius:20px;width:90%;max-width:500px;">
            <h3 style="margin-bottom:20px;color:white;"><i class="fas fa-user-edit"></i> Edit User</h3>
            <form id="editUserForm">
                <input type="hidden" id="editUserId">
                <div style="margin-bottom:15px;">
                    <label style="color:white;display:block;margin-bottom:5px;">Username</label>
                    <input type="text" id="editUsername" style="width:100%;padding:10px;border:none;border-radius:8px;">
                </div>
                <div style="margin-bottom:15px;">
                    <label style="color:white;display:block;margin-bottom:5px;">Email</label>
                    <input type="email" id="editEmail" style="width:100%;padding:10px;border:none;border-radius:8px;">
                </div>
                <div style="margin-bottom:15px;">
                    <label style="color:white;display:block;margin-bottom:5px;">First Name</label>
                    <input type="text" id="editFirstName" style="width:100%;padding:10px;border:none;border-radius:8px;">
                </div>
                <div style="margin-bottom:20px;">
                    <label style="color:white;display:block;margin-bottom:5px;">Last Name</label>
                    <input type="text" id="editLastName" style="width:100%;padding:10px;border:none;border-radius:8px;">
                </div>
                <div style="display:flex;gap:10px;justify-content:flex-end;">
                    <button type="button" onclick="closeEditModal()" style="padding:10px 20px;background:rgba(255,255,255,0.2);color:white;border:none;border-radius:8px;cursor:pointer;">Cancel</button>
                    <button type="submit" style="padding:10px 20px;background:#4cc9f0;color:white;border:none;border-radius:8px;cursor:pointer;">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let userGrowthChart;
        let currentPeriod = 'week';
        
        // Initialize chart
        function initChart() {
            const ctx = document.getElementById('userGrowthChart').getContext('2d');
            userGrowthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'New Users',
                        data: [],
                        borderColor: '#4cc9f0',
                        backgroundColor: 'rgba(76, 201, 240, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#4cc9f0',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: 'white' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }
        
        // Update growth chart
        function updateGrowthChart(period) {
            currentPeriod = period;
            
            // Update active button
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-period="${period}"]`).classList.add('active');
            
            // Show loading
            document.getElementById('chartLoading').style.display = 'block';
            
            // Fetch data
            fetch(`/api/user-growth-data/?period=${period}`)
                .then(response => response.json())
                .then(data => {
                    const labels = data.data.map(item => item.label);
                    const counts = data.data.map(item => item.count);
                    
                    userGrowthChart.data.labels = labels;
                    userGrowthChart.data.datasets[0].data = counts;
                    userGrowthChart.update();
                    
                    document.getElementById('chartLoading').style.display = 'none';
                })
                .catch(error => {
                    console.error('Error fetching growth data:', error);
                    document.getElementById('chartLoading').style.display = 'none';
                });
        }
        
        // Update real-time stats
        function updateStats() {
            fetch('/api/real-time-analytics/')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('totalUsers').textContent = data.current_stats.total_users;
                    document.getElementById('newToday').textContent = data.current_stats.new_today;
                    document.getElementById('activeUsers').textContent = data.current_stats.active_users;
                    document.getElementById('quizzesToday').textContent = data.current_stats.quizzes_today;
                })
                .catch(error => console.error('Error fetching stats:', error));
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
            updateGrowthChart('week');
            updateStats();
            
            // Update stats every 30 seconds
            setInterval(updateStats, 30000);
            
            // Update chart every 2 minutes
            setInterval(() => updateGrowthChart(currentPeriod), 120000);
        });
        
        // User management functions
        function editUser(id, username, email, firstName, lastName) {
            document.getElementById('editUserId').value = id;
            document.getElementById('editUsername').value = username;
            document.getElementById('editEmail').value = email;
            document.getElementById('editFirstName').value = firstName;
            document.getElementById('editLastName').value = lastName;
            document.getElementById('editModal').style.display = 'block';
        }
        
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }
        
        function blockUser(id, username) {
            if (confirm(`Are you sure you want to block user "${username}"? They will not be able to access the platform.`)) {
                fetch('/admin/block-user/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                    },
                    body: JSON.stringify({ user_id: id, action: 'block' })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => alert('Error blocking user'));
            }
        }
        
        function unblockUser(id, username) {
            if (confirm(`Are you sure you want to unblock user "${username}"?`)) {
                fetch('/admin/block-user/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                    },
                    body: JSON.stringify({ user_id: id, action: 'unblock' })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => alert('Error unblocking user'));
            }
        }
        
        // Handle edit form submission
        document.getElementById('editUserForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                user_id: document.getElementById('editUserId').value,
                username: document.getElementById('editUsername').value,
                email: document.getElementById('editEmail').value,
                first_name: document.getElementById('editFirstName').value,
                last_name: document.getElementById('editLastName').value
            };
            
            fetch('/admin/edit-user/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeEditModal();
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => alert('Error updating user'));
        });
        
        // Close modal when clicking outside
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });
    </script>
</body>
</html>